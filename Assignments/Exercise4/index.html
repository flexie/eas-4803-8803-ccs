<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Exercise 4: Fourier and Radon filtering - Seismic Monitoring CCS</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Seismic Monitoring CCS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Outline</a>
                            </li>
                            <li class="navitem">
                                <a href="../../goals/" class="nav-link">Goals</a>
                            </li>
                            <li class="navitem">
                                <a href="../../reading/" class="nav-link">Reading</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Homework</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#exercise-4-fourier-and-radon-filtering" class="nav-link">Exercise 4: Fourier and Radon filtering</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#questions" class="nav-link">Questions:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#questions_1" class="nav-link">Questions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#radon-transform" class="nav-link">Radon transform</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#questions_2" class="nav-link">Questions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="exercise-4-fourier-and-radon-filtering">Exercise 4: Fourier and Radon filtering</h1>
<p>In this exercise we will look at seismic data in different domains and investigate how we can exploit behaviour of different kinds of noise in these domains to design filters.</p>
<p>Contents:
- Data
- Temporal Fourier transform
- f-k filtering
- Radon transform
- Parabolic Radon transform</p>
<pre><code class="language-julia">using PyPlot, SegyIO, FFTW
</code></pre>
<p><strong>Data</strong></p>
<p>We use a single midpoint gather of the data used in the previous exercises: shot.segy (no big endian this time).</p>
<pre><code class="language-julia"># Dowload and adapt path
shot = segy_read(&quot;/home/yzhang3198/Downloads/data_segy/shot.segy&quot;)

shot_data = Float32.(shot.data)

h = get_header(shot, &quot;SourceX&quot;, scale=false) - get_header(shot, &quot;GroupX&quot;, scale=false)
dt = get_header(shot, &quot;dt&quot;)[1]/1e6
nt = get_header(shot, &quot;ns&quot;)[1]
T = 0:dt:(nt -1)*dt
</code></pre>
<pre><code>┌ Warning: Fixed length trace flag set in stream: IOBuffer(data=UInt8[...], readable=true, writable=false, seekable=true, append=false, size=1705444, maxsize=Inf, ptr=3601, mark=-1)
└ @ SegyIO /home/yzhang3198/.julia/packages/SegyIO/ak2qG/src/read/read_file.jl:26





0.0:0.004:4.0
</code></pre>
<pre><code class="language-julia">imshow(shot_data, vmin=-1, vmax=1, cmap=&quot;Greys&quot;, extent=[h[end], h[1], T[end], T[1]], aspect=1000)
xlabel(&quot;offset [m]&quot;);ylabel(&quot;time [s]&quot;);
</code></pre>
<p><img alt="png" src="../../img/E4_output_4_0.png" /></p>
<p><strong>Temporal Fourier transform</strong></p>
<p>We can use fftrl to perform a Fourier transform along the temporal direction. The power spectrum (i.e., the absolute value of the transformed data) looks like</p>
<pre><code class="language-julia">function fftrl(a, t, mode)
    # fft for real-valued vectors
    #
    # Tristan van Leeuwen, 2012
    # tleeuwen@eos.ubc.ca
    #
    # use:
    #   [b,f] = fftrl(a,t,mode)
    #
    # input:
    #   a - input data
    #   t - time vector
    #   mode: 1: forward, -1:inverse
    #
    # output:
    #   b - vector

    nt = length(t)
    dt = t[2] - t[1]
    nf = Int(floor(nt/2)) + 1
    tmax = t[end] - t[1]
    f = 0:1/tmax:.5/dt
    if mode == 1
        b = fft(a,1)
        b = b[1:nf,:]
    elseif mode == -1
        a = [a;conj(a[Int(ceil(nt/2)):-1:2,:])]
        b = ifft(a, 1)
        b = real(b)
    else
        error(&quot;Unknown mode&quot;)
    end

    return b, f
end

</code></pre>
<pre><code>fftrl (generic function with 1 method)
</code></pre>
<pre><code class="language-julia">Data_fh, f = fftrl(shot_data, T, 1)
</code></pre>
<pre><code>(Complex{Float32}[0.6844337f0 + 0.0f0im 0.9717815f0 + 0.0f0im … 0.09694278f0 + 0.0f0im 0.004332781f0 + 0.0f0im; -0.70118594f0 - 0.4517814f0im -0.41232893f0 - 0.46060145f0im … -1.3077996f0 - 0.49731374f0im -1.4023542f0 - 0.48800778f0im; … ; -0.121281974f0 + 0.0007099677f0im -0.08637722f0 - 0.00040336605f0im … 0.1578058f0 - 0.0011496469f0im 0.11014599f0 - 0.0002730284f0im; -0.12202144f0 + 0.00059955195f0im -0.08491863f0 - 0.00023266952f0im … 0.15901898f0 - 0.0005980283f0im 0.10969794f0 - 0.00018512644f0im], 0.0:0.25:125.0)
</code></pre>
<pre><code class="language-julia">imshow(abs.(Data_fh), cmap=&quot;jet&quot;, extent=[h[end], h[1], f[end], f[1]], aspect=20)
xlabel(&quot;offset [m]&quot;);ylabel(&quot;frequency [Hz]&quot;)
</code></pre>
<p><img alt="png" src="../../img/E4_output_8_0.png" /></p>
<pre><code>PyObject Text(24.000000000000007, 0.5, 'frequency [Hz]')
</code></pre>
<p><strong>f-k filtering</strong>
A Fourier transform along both time and offset direction is often referred to as an  transform. We can use fktran. The powerspectrum looks like</p>
<pre><code class="language-julia">function fktran(a,t,x,mode)
    &quot;&quot;&quot;
    f-k transform for real-values input.

    use:
        b, f, k = fktran(a,t,x,mode)

    input:
        a - matrix in t-x domain (nt x nx)
        t - time vector
        x - x vector
        mode - 1:forward, -1:inverse
    &quot;&quot;&quot;

    nt = length(t)
    nx = length(x)

    dt = t[2]-t[1]
    dx = x[2] - x[1]

    xmax = x[end] - x[1]
    tmax = t[end] - t[1]


    f = 0:1/tmax:.5/dt
    k = -.5/dx:1/xmax:.5/dx

    nf = length(f)
    if mode == 1
        b = fft(a, 1)
        b = b[1:nf, :]
        b = ifft(b, 2)
        b = circshift(b,[0 ceil(Int, nx/2)-1]);
    elseif mode == -1
        b = circshift(a,[0 floor(Int, nx/2)+1]);
        b = fft(b, 2)
        b = ifft([b;conj(b[end:-1:2,:])], 1)
        b = real(b)
    else
        error(&quot;unknown mode&quot;)
    end
    return b, f, k
end
</code></pre>
<pre><code>fktran (generic function with 1 method)
</code></pre>
<pre><code class="language-julia">Data_fk, fk, kx = fktran(shot_data, T, h, 1)
</code></pre>
<pre><code>(Complex{Float32}[0.002173217f0 + 0.37586603f0im -0.003716143f0 - 0.37589622f0im … -0.0037163715f0 + 0.37589744f0im 0.0021728363f0 - 0.37586543f0im; -0.06664165f0 + 0.37817085f0im 0.06513726f0 - 0.37864232f0im … -0.072564445f0 + 0.37711513f0im 0.07105575f0 - 0.37754175f0im; … ; 0.0033008547f0 + 0.40090138f0im -0.006969956f0 - 0.40087533f0im … -0.002999703f0 + 0.40091997f0im -0.0006929431f0 - 0.40090662f0im; 0.0019657868f0 + 0.40089262f0im -0.0056476546f0 - 0.4009117f0im … -0.0043306802f0 + 0.4009047f0im 0.000641849f0 - 0.4008996f0im], 0.0:0.25:125.0, 0.05:-0.00025:-0.05)
</code></pre>
<pre><code class="language-julia">imshow(abs.(Data_fk), cmap=&quot;jet&quot;, extent=[kx[end], kx[1], f[end], f[1]], aspect=.001)
xlabel(&quot;wavenumber [1/m&quot;);ylabel(&quot;frequency [Hz]&quot;)
</code></pre>
<p><img alt="png" src="../../img/E4_output_12_0.png" /></p>
<pre><code>PyObject Text(23.999999999999993, 0.5, 'frequency [Hz]')
</code></pre>
<pre><code class="language-julia">back, _, _ = fktran(Data_fk, fk, kx, -1)
imshow(back, vmin=-1, vmax=1, cmap=&quot;Greys&quot;, extent=[h[end], h[1], T[end], T[1]], aspect=1000)
xlabel(&quot;offset [m]&quot;);ylabel(&quot;time [s]&quot;);
</code></pre>
<p><img alt="png" src="../../img/E4_output_13_0.png" /></p>
<pre><code class="language-julia">size(shot_data)
</code></pre>
<pre><code>(1001, 401)
</code></pre>
<h1 id="questions">Questions:</h1>
<p>Subsample the data in the offset direction and look at the Fourier transform. (Hint: use Data[:,1:n:end] and h[1:n:end] where n is the number of times you want to subsample).</p>
<ul>
<li>What do you see?</li>
<li>Why is it important to have a good receiver sampling?</li>
</ul>
<p>A filter is simply a multiplicative factor applied in some transform domain, typically <span class="arithmatex">\(f-h\)</span> or <span class="arithmatex">\(f-k\)</span>, followed by an inverse transform. For example, a band-pass filter in the <span class="arithmatex">\(f-h\)</span> domain filters out higher temporal frequencies by setting them to zero. A simple band-pass filter looks like this:</p>
<pre><code class="language-julia">F_hp = ones(length(f),length(h))
F_hp[(f.&lt;5) .| (f.&gt;20.),:] .= 0

imshow(F_hp, extent=[h[end], h[1], f[end], f[1]], aspect=20)
colorbar()
xlabel(&quot;offset [m]&quot;);ylabel(&quot;frequency [Hz]&quot;)
</code></pre>
<p><img alt="png" src="../../img/E4_output_17_0.png" /></p>
<pre><code>PyObject Text(24.000000000000007, 0.5, 'frequency [Hz]')
</code></pre>
<p>The filtered data looks like this</p>
<pre><code class="language-julia">imshow(fftrl(F_hp.*Data_fh, f, -1)[1], cmap=&quot;Greys&quot;, vmin=-1, vmax=1, extent=[h[end], h[1], T[end], T[1]], aspect=1000)
xlabel(&quot;offset [m]&quot;);ylabel(&quot;frequency [Hz]&quot;)
</code></pre>
<p><img alt="png" src="../../img/E4_output_19_0.png" /></p>
<pre><code>PyObject Text(24.000000000000007, 0.5, 'frequency [Hz]')
</code></pre>
<p>Do you see the artifacts? A way to reduce these artifacts is to smooth the filter. We can do this by convolving the filter with a triangular smoothing kernel. This is implemented in the function smooth_2D. The result looks like this:</p>
<pre><code class="language-julia">#using Pkg; Pkg.add(&quot;Images&quot;) of you do not alread yhave it
using Images

function smooth_2D(input, n1, n2)
    t1 = [1:n1; n1-1:-1:1]/n1^2
    t2 = [1:n2; n2-1:-1:1]/n2^2
    kernel = t1 * t2'
    return imfilter(input, centered(kernel))
end
</code></pre>
<pre><code>smooth_2D (generic function with 1 method)
</code></pre>
<pre><code class="language-julia">F_hp_smooth = smooth_2D(F_hp, 5, 1)
imshow(F_hp_smooth, extent=[h[end], h[1], f[end], f[1]], aspect=20)
colorbar()
xlabel(&quot;offset [m]&quot;);ylabel(&quot;frequency [Hz]&quot;)
</code></pre>
<p><img alt="png" src="../../img/E4_output_22_0.png" /></p>
<pre><code>PyObject Text(24.000000000000007, 0.5, 'frequency [Hz]')
</code></pre>
<pre><code class="language-julia">imshow(fftrl(F_hp_smooth.*Data_fh, f, -1)[1], cmap=&quot;Greys&quot;, vmin=-1, vmax=1, extent=[h[end], h[1], T[end], T[1]], aspect=1000)
xlabel(&quot;offset [m]&quot;);ylabel(&quot;frequency [Hz]&quot;)

</code></pre>
<p><img alt="png" src="../../img/E4_output_23_0.png" /></p>
<pre><code>PyObject Text(24.000000000000007, 0.5, 'frequency [Hz]')
</code></pre>
<p>A (smoothed) filter in the <span class="arithmatex">\(f-k\)</span> domain may look like this</p>
<pre><code class="language-julia">ff = [fi for fi in f, kxi in kx]
kkx = [kxi for fi in f, kxi in kx]
F_kx = zeros(length(fk),length(kx))

F_kx[(ff -1e3 * abs.(kkx) .&gt; 5) .&amp; (ff.&lt;60)] .= 1

F_kx = smooth_2D(F_kx, 5, 5)

imshow(F_kx, cmap=&quot;jet&quot;, extent=[kx[end], kx[1], f[end], f[1]], aspect=.001)
xlabel(&quot;wavenumber [1/m&quot;);ylabel(&quot;frequency [Hz]&quot;)
</code></pre>
<p><img alt="png" src="../../img/E4_output_25_0.png" /></p>
<pre><code>PyObject Text(23.999999999999993, 0.5, 'frequency [Hz]')
</code></pre>
<h1 id="questions_1">Questions</h1>
<p>Describe how you would design filters to clean up shot gathers shot_noise1 and shot_noise2. (hint: look the f-k transform and compare to the orinigal data)
Try it and compare the result with the original shot gather.</p>
<h1 id="radon-transform">Radon transform</h1>
<p>The Radon tranform performs sums along lines with different intercepts <span class="arithmatex">\(\tau\)</span>) and slopes <span class="arithmatex">\(p\)</span>. Hence, it is sometimes refered to as the <span class="arithmatex">\(\tau-p\)</span> transform in geophysics.</p>
<p><span class="arithmatex">\(\hat{d}(\tau,p) = \int\mathrm{d}h\, d(t + ph, h)\)</span></p>
<p>The transform is implemented in the function lpradon.</p>
<p>To get an idea of what this transform does, we consider the simple example in lines.segy.</p>
<pre><code class="language-julia">function lpradon(input, t, h, q, power, mode)
    # linear and parabolic Radon transform and its adjoint.
    #
    # Tristan van Leeuwen, 2012
    # tleeuwen@eos.ubc.ca
    #
    # use:
    #   out = lpradon(input,t,h,q,power,mode)
    #
    # input:
    #   input - input matrix of size (length(t) x length(h)) for forward, (length(t) x length(q)) for adjoint)
    #   t     - time vector in seconds 
    #   h     - offset vecror in meters
    #   q     - radon parameter
    #   power - 1: linear radon, 2: parabolic radon
    #   mode  - 1: forward, -1: adjoint
    #
    # output:            println(size(L))
    #   output matrix of size (length(t) x length(q)) for forward, (length(t) x length(h)) for adjoint)
    #
    #
    dt   = t[2] - t[1]
    nt   = length(t)
    nh   = length(h)
    nq   = length(q)
    nfft = 2*(Int64(nextpow(2,nt)))

    input_padded = zeros(nfft, size(input)[2])
    input_padded[1:size(input)[1], :] = input[:, :]


    if mode == 1
        input_padded  = fft(input_padded, 1)
        out = zeros(Complex{Float64}, nfft, nq)
        for k = 2:Int(floor(nfft/2))
            f = 2 .*pi*(k-1)/nfft/dt
            L = exp.(im*f*(h.^power)*q')
            tmp = conj((input_padded[k,:]' *L)[end:-1:1])
            out[k,:] = tmp
            out[nfft + 2 - k, :] = conj(tmp)
        end
        out = real(ifft(out, 1))
        out = out[1:nt, :]
    else
        input_padded  = fft(input_padded,1)
        out = zeros(Complex{Float64}, nfft, nh)
        for k = 2:Int(floor(nfft/2))
            f = 2 .*pi*(k-1)/nfft/dt
            L = exp.(im*f*(h.^power)*q')
            tmp = conj((input_padded[k,:]' *L')[end:-1:1])
            out[k,:] = tmp
            out[nfft+2-k,:] = conj(tmp)
        end
        out = real(ifft(out,1))
        out = out[1:nt, :]
    end
    return out
end
</code></pre>
<pre><code>lpradon (generic function with 1 method)
</code></pre>
<pre><code class="language-julia"># Dowload and adapt path
shot_radon = segy_read(&quot;/home/yzhang3198/Downloads/data_segy/lines.segy&quot;)

A = Float32.(shot_radon.data)

h = get_header(shot_radon, &quot;SourceX&quot;, scale=false) - get_header(shot, &quot;GroupX&quot;, scale=false)
dt = get_header(shot_radon, &quot;dt&quot;)[1]/1e6
nt = get_header(shot_radon, &quot;ns&quot;)[1]
T = 0:dt:(nt -1)*dt
</code></pre>
<pre><code>┌ Warning: Fixed length trace flag set in stream: IOBuffer(data=UInt8[...], readable=true, writable=false, seekable=true, append=false, size=1705444, maxsize=Inf, ptr=3601, mark=-1)
└ @ SegyIO /home/yzhang3198/.julia/packages/SegyIO/ak2qG/src/read/read_file.jl:26





0.0:0.004:4.0
</code></pre>
<pre><code class="language-julia">imshow(A, vmin=-.1, vmax=.1, cmap=&quot;Greys&quot;, extent=[h[end], h[1], T[end], T[1]], aspect=1000)
xlabel(&quot;offset [m]&quot;);ylabel(&quot;time [s]&quot;);
</code></pre>
<p><img alt="png" src="../../img/E4_output_30_0.png" /></p>
<pre><code class="language-julia"># which p-values
p = 1e-3.*(-3:.05:3)

# transform
A_tp = lpradon(A, T, h, p, 1, 1);
</code></pre>
<pre><code class="language-julia"># plot
imshow(A_tp, vmin=-.25, vmax=.25, cmap=&quot;Greys&quot;, extent=[p[1], p[end], T[end], T[1]], aspect=.001)
xlabel(&quot;slowness [s/m]&quot;);ylabel(&quot;time [s]&quot;);

</code></pre>
<p><img alt="png" src="../../img/E4_output_32_0.png" /></p>
<h1 id="questions_2">Questions</h1>
<p>Can you interpret the results?
Describe how you would design <code>filters</code> in the <span class="arithmatex">\(\tau-p\)</span> domain to separate the different events.
Try it. Use the <code>adjoint</code> option of the transform to transform back to the physical domain.</p>
<pre><code class="language-julia">
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
