<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Exercise 7 : Seismic imaging - Seismic Monitoring CCS</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Seismic Monitoring CCS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Outline</a>
                            </li>
                            <li class="navitem">
                                <a href="../../goals/" class="nav-link">Goals</a>
                            </li>
                            <li class="navitem">
                                <a href="../../reading/" class="nav-link">Reading</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Homework</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#exercise-7-seismic-imaging" class="nav-link">Exercise 7 : Seismic imaging</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#set-up-the-experiment" class="nav-link">Set up the experiment</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#generate-data" class="nav-link">Generate data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-plot-a-single-shot-record-of-dobs-and-dobs0-choose-the-same-source-what-do-you-see-in-the-shot-record-if-there-are-a-couple-of-events-try-to-match-them-up-with-the-corresponding-reflectors" class="nav-link">Task: plot a single shot record of dobs and dobs0. Choose the same source. What do you see in the shot record? If there are a couple of events, try to match them up with the corresponding reflectors.</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-do-the-same-comparison-of-dlin-and-dobs-dobs0-what-do-you-see-why-do-you-observe-this-theoretically-think-about-math" class="nav-link">Task: do the same comparison of dlin and dobs-dobs0. What do you see? Why do you observe this theoretically (think about math)?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#reverse-time-migration-rtm" class="nav-link">Reverse time migration (RTM)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-compare-rtm-results-w-and-wo-isic-what-do-you-see-remember-again-to-clip-the-vminvmax-to-see-all-the-events-in-the-images" class="nav-link">Task: compare RTM results w/ and w/o ISIC, what do you see? Remember again to clip the vmin/vmax to see all the events in the images.</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#least-squares-reverse-time-migration-ls-rtm" class="nav-link">Least-squares reverse time migration (LS-RTM)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-compare-ls-rtm-result-with-the-previous-rtm-result-what-do-you-see" class="nav-link">Task: compare LS-RTM result with the previous RTM result, what do you see?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sparsity-promoting-least-squares-reverse-time-migration-spls-rtm" class="nav-link">Sparsity-promoting least-squares reverse time migration (SPLS-RTM)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-compare-the-image-from-lsqr-and-linearized-bregman-what-do-you-see-remember-again-about-clipping" class="nav-link">Task: compare the image from LSQR and linearized Bregman. What do you see? Remember again about clipping</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-the-images-recovered-above-are-focusing-only-in-the-central-region-why-hint-check-sourcereceiver-locations-how-can-we-get-a-full-illumination-of-the-image-make-experiments-to-verify" class="nav-link">Task: the images recovered above are focusing only in the central region. Why? (Hint: check source/receiver locations) How can we get a full illumination of the image? Make experiments to verify.</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#task-change-acquisition-to-be-transmission-eg-put-sources-as-a-vertical-line-on-the-left-receivers-on-the-right-show-what-rtm-image-looks-like-is-it-the-same-as-you-got-from-the-reflective-seismic" class="nav-link">Task: change acquisition to be transmission -- e.g. put sources as a vertical line on the left, receivers on the right. Show what RTM image looks like. Is it the same as you got from the reflective seismic?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="exercise-7-seismic-imaging">Exercise 7 : Seismic imaging</h1>
<p>In this exercise, we conduct a small 2D seismic imaging experiment on a 4-layer model example with <a href="https://github.com/slimgroup/JUDI.jl">JUDI</a>. We suggest you use a Docker image to run the experiment so that software packages are properly installed. To use the docker image, first install docker. Then, in the terminal, do </p>
<pre><code class="language-bash">docker run -p 8888:8888 ddjj1118/judi_eas_project:v4.0
</code></pre>
<p>Running this command will produce an output that looks like</p>
<pre><code>
    Copy/paste this URL into your browser when you connect for the first time,
    to login with a token:
           http://af637030c092:8888/?token=8f6c664eb945f9c6b7cd72669fef04a6dc70c08194cb87e9
        or http://127.0.0.1:8888/?token=8f6c664eb945f9c6b7cd72669fef04a6dc70c08194cb87e9
</code></pre>
<p>Copy paste the URL in your browser and replace <code>(af637030c092 or 127.0.0.1)</code> by <code>localhost</code>.
You will then be directed to a jupyter folder that contains the notebooks for the projects.</p>
<p>First, make sure we have the latest version of <a href="https://www.devitoproject.org">Devito</a> installed. You can do this by click NEW, then go for TERMINAL in the browser with jupyter folder, then do</p>
<pre><code class="language-bash">pip install devito==4.3
</code></pre>
<p>Then, we can create a new julia script and run the experiment in it.</p>
<h2 id="set-up-the-experiment">Set up the experiment</h2>
<pre><code class="language-julia">## First do using Pkg; Pkg.add(xxx); Pkg.update(xxx) to make sure they are installed and in the latest version
using JUDI, PyPlot, Images, JOLI, IterativeSolvers, LinearAlgebra, Printf, Statistics
</code></pre>
<p>Here, we set up a <code>4</code>-layer model, where the velocities in each layer are <code>1.5/2.5/3/3.5</code> km/s. We often refer the first layer as the water layer/column in marine acquisition.</p>
<pre><code class="language-julia"># number of gridpoints
n = (201, 101)

# Grid spacing
d = (10.0, 10.0)

# Origin
o = (0., 0.)

# Velocity [km/s]
v = ones(Float32,n) .+ 0.5f0
v[:,20:50] .= 2.5f0
v[:,51:71] .= 3f0
v[:,71:end] .= 3.5f0
</code></pre>
<p>Wave-equation simulations in JUDI are based on squared slowness <code>m</code>. Also, we make up a background model <code>m0</code> which is a smoothed version of the ground truth one. To make things simple, we assume to know the exact depth of ocean bottom and keep the water column fixed in the background model. The <code>dm</code>, as the difference of <code>m</code> and <code>m0</code>, only contains the sharp reflectors.</p>
<pre><code class="language-julia"># Slowness squared [s^2/km^2]
m = (1f0 ./ v).^2
m0 = convert(Array{Float32,2},imfilter(m, Kernel.gaussian(2)))
m0[:,1:19] = m[:,1:19]
dm = vec(m - m0)

figure();
subplot(1,3,1)
imshow(reshape(m,n)');title(&quot;m&quot;)
subplot(1,3,2)
imshow(reshape(m0,n)');title(&quot;m0&quot;)
subplot(1,3,3)
imshow(reshape(dm,n)',cmap=&quot;Greys&quot;);title(&quot;dm&quot;)
</code></pre>
<p><code>m</code> and <code>m0</code> are stored in <code>model</code> structure in JUDI, with physical information.</p>
<pre><code class="language-julia">model0 = Model(n, d, o, m0; nb = 80)
model = Model(n, d, o, m; nb = 80)
</code></pre>
<p>We set up the source geometry and receiver geometry as below. Simulations are in 2D so <code>y</code>-direction is always <code>0</code>. The sources are assumed to fire one-by-one while receivers are fixed.</p>
<pre><code class="language-julia">
nsrc = 8 # num of sources
xsrc = convertToCell(range(900f0, stop=1100f0, length=nsrc)) # in [m]
ysrc = convertToCell(range(0f0, stop=0f0, length=nsrc)) # in [m]
zsrc = convertToCell(range(6f0, stop=6f0, length=nsrc)) # in [m]

timeS = 1000f0 # recording time [ms]
dtS = 1f0 # time sampling [ms]

srcGeometry = Geometry(xsrc,ysrc,zsrc; dt=dtS, t=timeS)

nrec = 100 # num of receivers
xrec = range(d[1], stop=(n[1]-1)*d[1], length=nrec) # in [m]
yrec = 0f0  # in [m]
zrec = range(10f0, stop=10f0, length=nrec)  # in [m]

timeR = 1000f0 # recording time [ms]
dtR = 1f0 # time sampling [ms]

recGeometry = Geometry(xrec,yrec,zrec;dt=dtR,t=timeR, nsrc=nsrc)

</code></pre>
<p>Set up the source with Ricker wavelet</p>
<pre><code class="language-julia">
f0 = 0.02f0  # 20 Hz wavelet
wavelet = ricker_wavelet(timeS, dtS, f0)
q = judiVector(srcGeometry, wavelet)

</code></pre>
<p>Set up computational time step</p>
<pre><code class="language-julia">
# Set up info structure for linear operators
ntComp = get_computational_nt(srcGeometry, recGeometry, model)
info = Info(prod(n), nsrc, ntComp)

</code></pre>
<p>Set up forward modeling operators in ground truth velocity, background velocity, and migration operator</p>
<pre><code class="language-julia">F = judiModeling(info, model, srcGeometry, recGeometry) # forward modeling w/ true model
F0 = judiModeling(info, model0, srcGeometry, recGeometry) # forward modeling w/ background model
J = judiJacobian(F0,q) # demigration operator (adjoint of J is migration)
</code></pre>
<h2 id="generate-data">Generate data</h2>
<p>Generate data in ground truth velocity and background velocity</p>
<pre><code class="language-julia">dobs = F*q
dobs0 = F0*q
</code></pre>
<h2 id="task-plot-a-single-shot-record-of-dobs-and-dobs0-choose-the-same-source-what-do-you-see-in-the-shot-record-if-there-are-a-couple-of-events-try-to-match-them-up-with-the-corresponding-reflectors"><em>Task: plot a single shot record of <code>dobs</code> and <code>dobs0</code>. Choose the same source. What do you see in the shot record? If there are a couple of events, try to match them up with the corresponding reflectors.</em></h2>
<pre><code class="language-julia"># hint: seismic data is as a judiVector
# you can do this by figure();imshow(dobs.data[1],vmin=-0.02*norm(dobs.data[1],Inf),cmap=&quot;seismic&quot;,vmax=0.02*norm(dobs.data[1],Inf),aspect=&quot;auto&quot;)
# This plots the shot record in correct velocity generated by the 1st source
# IMPORTANT: always adjust vmin, vmax, aspect so that we can see the events clearly
</code></pre>
<p>You can also generate a linearized shot record by</p>
<pre><code class="language-julia">dlin = J*dm
</code></pre>
<h2 id="task-do-the-same-comparison-of-dlin-and-dobs-dobs0-what-do-you-see-why-do-you-observe-this-theoretically-think-about-math"><em>Task: do the same comparison of <code>dlin</code> and <code>dobs-dobs0</code>. What do you see? Why do you observe this theoretically (think about math)?</em></h2>
<h2 id="reverse-time-migration-rtm">Reverse time migration (RTM)</h2>
<p>From now on, we will only focusing on migrating the linearized data for simplicity. First, we can try reverse time migration by</p>
<pre><code class="language-julia">rtm1 = J'*dlin
</code></pre>
<p>To make the RTM image cleaner and with higher quality, <a href="https://slim.gatech.edu/Publications/Public/Conferences/EAGE/2017/witte2017EAGEspl/witte2017EAGEspl.html">Witte et al</a> developed an inverse-scattering imaging condition (ISIC), which has been incorporated in JUDI.</p>
<pre><code class="language-julia">J.options.isic = true
rtm2 = J'*dlin
</code></pre>
<h2 id="task-compare-rtm-results-w-and-wo-isic-what-do-you-see-remember-again-to-clip-the-vminvmax-to-see-all-the-events-in-the-images"><em>Task: compare RTM results w/ and w/o ISIC, what do you see? Remember again to clip the vmin/vmax to see all the events in the images.</em></h2>
<pre><code class="language-julia"># hint: rtm1/rtm2 are PhysicalParameters. Do rtm1.data, rtm2.data to access the value. Again take care of vmin, vmax, aspect of plotting.
</code></pre>
<h2 id="least-squares-reverse-time-migration-ls-rtm">Least-squares reverse time migration (LS-RTM)</h2>
<p>Seismic imaging researchers are not always satisfied with RTM. Seismic imaging basically solves the optimization problem</p>
<pre><code class="language-math">\min_{\mathbf{\delta m}} \frac{1}{2}\sum_{i=1}^{n_s}\|\mathcal{J}_i\mathbf{\delta m} - \mathbf{\delta d}\|_2^2
</code></pre>
<p>where RTM is only taking a full gradient of the objective w.r.t. <code>\delta m</code>. To get better images, we can minimize the objective by LSQR and apply a right preconditioner</p>
<pre><code class="language-julia">
# Right Preconditioner
Tm = judiTopmute(model0.n, 19, 2)  # Mute water column
S = judiDepthScaling(model0)
Mr = S*Tm

## vanilla LSQR

x1 = 0f0 .* model0.m

lsqr!(x1,J*Mr,dlin;maxiter=2,atol=0f0,verbose=true)
</code></pre>
<p>The final solution is given by <code>Mr*x1</code> (<code>Mr</code> is a right preconditioner so we are actually minimizing <code>\frac{1}{2}\|\mathcal{J}\mathbf{M_r}\mathbf{x}- \mathbf{\delta d}\|_2^2</code>)</p>
<h2 id="task-compare-ls-rtm-result-with-the-previous-rtm-result-what-do-you-see"><em>Task: compare LS-RTM result with the previous RTM result, what do you see?</em></h2>
<h2 id="sparsity-promoting-least-squares-reverse-time-migration-spls-rtm">Sparsity-promoting least-squares reverse time migration (SPLS-RTM)</h2>
<p>The start-of-the-art imaging technique is to do LS-RTM while promoting sparsity of solution in Curvelet domain, see <a href="https://slim.gatech.edu/content/compressive-least-squares-migration-fly-fourier-transforms">Witte et al</a>. This can be achieved by linearized Bregman iterations, as shown below</p>
<pre><code class="language-julia">
# Soft thresholding functions and Curvelet transform
soft_thresholding(x::Array{Float64}, lambda) = sign.(x) .* max.(abs.(x) .- convert(Float64, lambda), 0.0)
soft_thresholding(x::Array{Float32}, lambda) = sign.(x) .* max.(abs.(x) .- convert(Float32, lambda), 0f0)

n = model0.n
C0 = joCurvelet2D(n[1], 2*n[2]; zero_finest = false, DDT = Float32, RDT = Float64)

function C_fwd(im, C, n)
    im = hcat(reshape(im, n), reshape(im, n)[:, end:-1:1])
    coeffs = C*vec(im)
    return coeffs
end

function C_adj(coeffs, C, n)
    im = reshape(C'*coeffs, n[1], 2*n[2])
    return vec(im[:, 1:n[2]] .+ im[:, end:-1:n[2]+1])
end

C = joLinearFunctionFwd_T(size(C0, 1), n[1]*n[2],
                          x -&gt; C_fwd(x, C0, n),
                          b -&gt; C_adj(b, C0, n),
                          Float32,Float64, name=&quot;Cmirrorext&quot;)


src_list = Set(collect(1:nsrc))
batchsize = 2
lambda = 0f0

x2 = 0f0 .* model0.m
z = deepcopy(x2)

niter = 8

# Main loop
for j = 1:niter
    # Select batch and set up left-hand preconditioner
    length(src_list) &lt; batchsize &amp;&amp; (global src_list = Set(collect(1:nsrc)))
    i = [pop!(src_list) for b=1:batchsize]
    println(&quot;LS-RTM Iteration: $(j), imaging sources $(i)&quot;)
    flush(Base.stdout)

    residual = J[i]*Mr*x2-dlin[i]
    phi = 0.5 * norm(residual)^2
    g = Mr'*J[i]'*residual

    # Step size and update variable
    t = Float32.(2*phi/norm(g)^2)

    # Update variables and save snapshot
    global z -= t*g
    C_z = C*z
    (j==1) &amp;&amp; (global lambda = quantile(abs.(C_z), .95))   # estimate thresholding parameter in 1st iteration
    global x2 = adjoint(C)*soft_thresholding(C_z, lambda)

    @printf(&quot;At iteration %d function value is %2.2e and step length is %2.2e \n&quot;, j, phi, t)
    @printf(&quot;Lambda is %2.2e \n&quot;, lambda)
end

</code></pre>
<p>The solution is given by <code>Mr*x2</code>.</p>
<h2 id="task-compare-the-image-from-lsqr-and-linearized-bregman-what-do-you-see-remember-again-about-clipping"><em>Task: compare the image from LSQR and linearized Bregman. What do you see? Remember again about clipping</em></h2>
<h2 id="task-the-images-recovered-above-are-focusing-only-in-the-central-region-why-hint-check-sourcereceiver-locations-how-can-we-get-a-full-illumination-of-the-image-make-experiments-to-verify"><em>Task: the images recovered above are focusing only in the central region. Why? (Hint: check source/receiver locations) How can we get a full illumination of the image? Make experiments to verify.</em></h2>
<h2 id="task-change-acquisition-to-be-transmission-eg-put-sources-as-a-vertical-line-on-the-left-receivers-on-the-right-show-what-rtm-image-looks-like-is-it-the-same-as-you-got-from-the-reflective-seismic"><em>Task: change acquisition to be transmission -- e.g. put sources as a vertical line on the left, receivers on the right. Show what RTM image looks like. Is it the same as you got from the reflective seismic?</em></h2></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
