<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Homework 4 : Seismic imaging - Seismic Monitoring CCS</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Seismic Monitoring CCS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Outline</a>
                            </li>
                            <li class="navitem">
                                <a href="../../reading/" class="nav-link">Reading</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Homework</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Project</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#homework-4-seismic-imaging" class="nav-link">Homework 4 : Seismic imaging</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#lets-start" class="nav-link">Let's start!</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#generate-data" class="nav-link">Generate data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#reverse-time-migration-rtm" class="nav-link">Reverse time migration (RTM)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#least-squares-reverse-time-migration-ls-rtm" class="nav-link">Least-squares reverse time migration (LS-RTM)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sparsity-promoting-least-squares-reverse-time-migration-spls-rtm" class="nav-link">Sparsity-promoting least-squares reverse time migration (SPLS-RTM)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="homework-4-seismic-imaging">Homework 4 : Seismic imaging</h1>
<p>In this exercise, we conduct a small 2D seismic imaging experiment on a 4-layer model example with <a href="https://github.com/slimgroup/JUDI.jl">JUDI</a>. We suggest you use a Docker image to run the experiment so that software packages are properly installed. To use the docker image, first install docker. Then, in the terminal, do </p>
<pre><code class="language-bash">docker run -p 8888:8888 ziyiyin97/ccs-env:v4.4
</code></pre>
<p>Running this command will produce an output that looks like</p>
<pre><code>
    Copy/paste this URL into your browser when you connect for the first time,
    to login with a token:
           http://af637030c092:8888/?token=8f6c664eb945f9c6b7cd72669fef04a6dc70c08194cb87e9
        or http://127.0.0.1:8888/?token=8f6c664eb945f9c6b7cd72669fef04a6dc70c08194cb87e9
</code></pre>
<p>Copy paste the URL in your browser and replace <code>(af637030c092 or 127.0.0.1)</code> by <code>localhost</code>.
You will then be directed to a jupyter folder that contains the notebooks for the projects.</p>
<p>Then, we can create a new julia script and run the experiment in it. A couple of things before we go into the details:</p>
<h3 id="1-try-to-give-your-interpretation-to-every-figure-you-plot-what-is-each-event-in-the-figure">1. Try to give your interpretation to every figure you plot. What is each event in the figure?</h3>
<h3 id="2-plotting-is-hard-when-you-make-plots-make-sure-you-use-the-correct-labels-and-units-so-that-images-are-in-meters-data-is-in-seconds-also-make-sure-you-clip-the-image-by-vmin-and-vmax-keywords-in-imshow-function-so-that-you-see-all-the-events-in-the-image">2. Plotting is hard. When you make plots, make sure you use the correct labels and units so that images are in meters, data is in seconds. Also make sure you clip the image by <code>vmin</code> and <code>vmax</code> keywords in <code>imshow</code> function so that you see all the events in the image.</h3>
<h3 id="3-to-plot-seismic-data-and-images-eg-rtm-we-always-put-vmin-vmax-so-that-0-is-at-the-center-in-your-colorscale-generally-we-use-cmapseismic-to-plot-seismic-data-cmapgreys-to-plot-seismic-images">3. To plot seismic data and images (e.g. RTM), we always put <code>vmin = -vmax</code> so that <span class="arithmatex">\(0\)</span> is at the center in your colorscale. Generally, we use <code>cmap="seismic"</code> to plot seismic data, <code>cmap="Greys"</code> to plot seismic images.</h3>
<h2 id="lets-start">Let's start!</h2>
<p>First we load the packages as usual.</p>
<pre><code class="language-julia">## First do using Pkg; Pkg.add(xxx) in case any package is not installed yet
using JUDI, PyPlot, Images, JOLI, IterativeSolvers, LinearAlgebra, Printf, Statistics
</code></pre>
<p>Here, we set up a <span class="arithmatex">\(4\)</span>-layer model. The velocities in each layer are <span class="arithmatex">\(1.5/2.5/3/3.5\)</span> km/s. We often call the first layer as the water layer/column in marine acquisition and assume to know its depth.</p>
<pre><code class="language-julia"># number of gridpoints
n = (201, 101)

# Grid spacing
d = (10f0, 10f0) # in [m]

# Origin
o = (0f0, 0f0) # in [m]

# Extent
extent = (o[1], o[1]+(n[1]-1)*d[1], o[2]+(n[2]-1)*d[2], o[2])   # in [m]

# Velocity [km/s]
v = ones(Float32,n) .+ 0.5f0
v[:,20:50] .= 2.5f0
v[:,51:71] .= 3f0
v[:,71:end] .= 3.5f0
</code></pre>
<p>Wave-equation simulations in JUDI are parameterized by squared slowness <span class="arithmatex">\(\mathbf{m}\)</span>. For migration, we make up a background model <span class="arithmatex">\(\mathbf{m}_0\)</span> as a smoothed version of the ground truth one. To make things simple, we assume to use the exact water layer in the background model. The squared slowness perturbation <span class="arithmatex">\(\delta\mathbf{m}\)</span>, as the difference of <span class="arithmatex">\(\mathbf{m}\)</span> and <span class="arithmatex">\(\mathbf{m}_0\)</span>, only contains the sharp reflectors.</p>
<pre><code class="language-julia"># Slowness squared [s^2/km^2]
m = (1f0 ./ v).^2
m0 = deepcopy(m)
m0[:,20:end] = convert(Array{Float32,2},imfilter(m[:,20:end], Kernel.gaussian(5)))  # smooth the true velocity to get m0
dm = vec(m - m0)

figure(figsize=(20,12));
subplot(1,3,1)
imshow(reshape(m,n)', extent=extent, interpolation=&quot;none&quot;, cmap=&quot;jet&quot;);title(&quot;m&quot;)
xlabel(&quot;X [m]&quot;); ylabel(&quot;Z [m]&quot;);
subplot(1,3,2)
imshow(reshape(m0,n)', extent=extent, interpolation=&quot;none&quot;, cmap=&quot;jet&quot;);title(&quot;m0&quot;)
xlabel(&quot;X [m]&quot;); ylabel(&quot;Z [m]&quot;);
subplot(1,3,3)
imshow(reshape(dm,n)', extent=extent, interpolation=&quot;none&quot;,cmap=&quot;Greys&quot;);title(&quot;dm&quot;)
xlabel(&quot;X [m]&quot;); ylabel(&quot;Z [m]&quot;);
</code></pre>
<p>The goal of seismic imaging/migration is to acquire this <span class="arithmatex">\(\delta\mathbf{m}\)</span> from seismic data. To run a seismic imaging experiment on the aforementioned model, let's start by generating the seismic data.</p>
<pre><code class="language-julia">model0 = Model(n, d, o, m0; nb = 80)
model = Model(n, d, o, m; nb = 80)
</code></pre>
<p>Here, <span class="arithmatex">\(\mathbf{m}\)</span> and <span class="arithmatex">\(\mathbf{m}_0\)</span> are stored in <code>model</code> structure in JUDI, with metadata (e.g. number of grid points, dimension, spacing etc). We then set up the source geometry and receiver geometry as below. Notice that the numerical simulations here are in 2D, so <span class="arithmatex">\(y\)</span>-direction is always <span class="arithmatex">\(0\)</span>.</p>
<pre><code class="language-julia">nsrc = 8 # num of sources
xsrc = range(900f0, stop=1100f0, length=nsrc) # in [m]
ysrc = range(0f0, stop=0f0, length=nsrc) # in [m]
zsrc = range(6f0, stop=6f0, length=nsrc) # in [m]

timeS = 1000f0 # source injection time [ms]
dtS = 1f0 # time sampling [ms]
ntS = Int(timeS/dtS) + 1    # number of time samples

srcGeometry = Geometry(convertToCell(xsrc),convertToCell(ysrc),convertToCell(zsrc); dt=dtS, t=timeS)

nrec = 100 # num of receivers
xrec = range(d[1], stop=(n[1]-1)*d[1], length=nrec) # in [m]
yrec = 0f0  # in [m]
zrec = range(10f0, stop=10f0, length=nrec)  # in [m]

timeR = 1000f0 # recording time [ms]
dtR = 1f0 # time sampling [ms]
ntR = Int(timeR/dtR) + 1    # number of time samples

recGeometry = Geometry(xrec,yrec,zrec;dt=dtR,t=timeR, nsrc=nsrc)
</code></pre>
<p>Set up the source with Ricker wavelet</p>
<pre><code class="language-julia">f0 = 0.015f0  # 15 Hz wavelet
wavelet = ricker_wavelet(timeS, dtS, f0)
q = judiVector(srcGeometry, wavelet)    # source
</code></pre>
<p>Set up computational time step</p>
<pre><code class="language-julia"># Set up info structure for linear operators
ntComp = get_computational_nt(srcGeometry, recGeometry, model)
info = Info(prod(n), nsrc, ntComp)
</code></pre>
<p>Set up forward modeling operators in ground truth velocity, background velocity, and migration operator --- these are linear operators!!</p>
<pre><code class="language-julia">F = judiModeling(info, model, srcGeometry, recGeometry; options=Options(isic=true)) # forward modeling w/ true model
F0 = judiModeling(info, model0, srcGeometry, recGeometry; options=Options(isic=true)) # forward modeling w/ background model
J = judiJacobian(F0,q) # demigration operator (adjoint of J is migration)
</code></pre>
<h3 id="task-please-plot-the-sourcesreceivers-overlaying-on-the-true-velocity-model-use-scatter-to-plot-scatter-points-in-an-image-where-are-the-sources-and-receivers"><em>Task: please plot the sources/receivers overlaying on the true velocity model. Use <code>scatter</code> to plot scatter points in an image. Where are the sources and receivers?</em></h3>
<h2 id="generate-data">Generate data</h2>
<p>Generate data in ground truth velocity and background velocity</p>
<pre><code class="language-julia">dobs = F*q
dobs0 = F0*q
</code></pre>
<h3 id="task-plot-a-single-shot-record-of-dobs-and-dobs0-choose-the-same-source-what-do-you-see-in-the-shot-record-if-there-are-a-couple-of-events-try-to-match-them-up-with-the-corresponding-reflectors"><em>Task: plot a single shot record of <code>dobs</code> and <code>dobs0</code>. Choose the same source. What do you see in the shot record? If there are a couple of events, try to match them up with the corresponding reflectors.</em></h3>
<pre><code class="language-julia"># hint: seismic data is as a judiVector
# you can access its value by, e.g.

figure(figsize=(20,12));imshow(dobs.data[1],extent=(1, nrec, (ntR-1)*dtR, 0f0), vmin=-0.02*norm(dobs.data[1],Inf),cmap=&quot;seismic&quot;,vmax=0.02*norm(dobs.data[1],Inf),aspect=&quot;auto&quot;)
xlabel(&quot;receiver no.&quot;);ylabel(&quot;[ms]&quot;);

# This plots the shot record in correct velocity generated by the 1st source
</code></pre>
<p>You can also generate a linearized shot record by</p>
<pre><code class="language-julia">dlin = J*dm
</code></pre>
<h3 id="task-plot-a-shot-record-from-dlin-and-dobs-dobs0-what-do-you-see-why-do-you-observe-this-theoretically-think-about-math"><em>Task: plot a shot record from <code>dlin</code> and <code>dobs-dobs0</code>. What do you see? Why do you observe this theoretically (think about math)?</em></h3>
<h2 id="reverse-time-migration-rtm">Reverse time migration (RTM)</h2>
<p>From now on, we will only focusing on imaging the linearized data for simplicity. First, we can try reverse time migration by</p>
<pre><code class="language-julia">rtm = J'*dlin
</code></pre>
<h3 id="task-compare-rtm-results-w-the-correct-squared-slowness-perturbation-dm-what-do-you-see-and-what-is-your-interpretation-on-the-result"><em>Task: compare RTM results w/ the correct squared slowness perturbation <code>dm</code>, what do you see and what is your interpretation on the result?</em></h3>
<pre><code class="language-julia"># hint: rtm is not a matrix, but a PhysicalParameters (a data structure). Do rtm.data to access the value. Again take care of vmin, vmax, aspect of plotting.
</code></pre>
<h2 id="least-squares-reverse-time-migration-ls-rtm">Least-squares reverse time migration (LS-RTM)</h2>
<p>Seismic imaging researchers are not always satisfied with RTM. Seismic imaging basically solves the optimization problem</p>
<p><span class="arithmatex">\(\min_{\mathbf{\delta m}} \|\mathbf{J}\mathbf{\delta m} - \mathbf{\delta d}\|_2^2\)</span></p>
<p>where RTM is only taking a full gradient of the objective w.r.t. <span class="arithmatex">\(\delta \mathbf{m}\)</span>. To get better images, we can minimize the objective by LSQR and apply a right preconditioner</p>
<pre><code class="language-julia">
# Right Preconditioner
Tm = judiTopmute(model0.n, 19, 2)  # Mute water column
S = judiDepthScaling(model0)
Mr = S*Tm

## vanilla LSQR

x1 = 0f0 .* model0.m

lsqr!(x1,J*Mr,dlin;maxiter=2,atol=0f0,verbose=true)
</code></pre>
<p>The final solution is given by <code>Mr*x1</code> (<code>Mr</code> is a right preconditioner so we are actually solving <span class="arithmatex">\(\min_{\mathbf{x}}\|\mathbf{J}\mathbf{M}_r\mathbf{x}- \mathbf{\delta d}\|_2^2\)</span>)</p>
<h3 id="task-compare-ls-rtm-result-with-the-previous-rtm-result-what-do-you-see"><em>Task: compare LS-RTM result with the previous RTM result, what do you see?</em></h3>
<h2 id="sparsity-promoting-least-squares-reverse-time-migration-spls-rtm">Sparsity-promoting least-squares reverse time migration (SPLS-RTM)</h2>
<p>The start-of-the-art imaging technique is to do LS-RTM while promoting sparsity of solution in Curvelet domain, see <a href="https://slim.gatech.edu/content/compressive-least-squares-migration-fly-fourier-transforms">Witte et al</a>. This can be achieved by linearized Bregman iterations, as shown below</p>
<pre><code class="language-julia"># Soft thresholding functions and Curvelet transform
soft_thresholding(x::Array{Float64}, lambda) = sign.(x) .* max.(abs.(x) .- convert(Float64, lambda), 0.0)
soft_thresholding(x::Array{Float32}, lambda) = sign.(x) .* max.(abs.(x) .- convert(Float32, lambda), 0f0)

C = joCurvelet2D(n[1], n[2]; zero_finest = false, DDT = Float32, RDT = Float64)

src_list = Set(collect(1:nsrc))
batchsize = 2
lambda = 0f0

x2 = 0f0 .* model0.m
z = deepcopy(x2)

niter = 8

# Main loop
for j = 1:niter
    # Select batch and set up left-hand preconditioner
    length(src_list) &lt; batchsize &amp;&amp; (global src_list = Set(collect(1:nsrc)))
    i = [pop!(src_list) for b=1:batchsize]
    println(&quot;LS-RTM Iteration: $(j), imaging sources $(i)&quot;)

    residual = J[i]*Mr*x2-dlin[i]
    phi = 0.5 * norm(residual)^2
    g = Mr'*J[i]'*residual

    # Step size and update variable
    t = Float32.(2*phi/norm(g)^2)

    # Update variables and save snapshot
    global z -= t*g
    C_z = C*z
    (j==1) &amp;&amp; (global lambda = quantile(abs.(C_z), .6))   # estimate thresholding parameter in 1st iteration
    global x2 = adjoint(C)*soft_thresholding(C_z, lambda)

    @printf(&quot;At iteration %d function value is %2.2e and step length is %2.2e \n&quot;, j, phi, t)
    @printf(&quot;Lambda is %2.2e \n&quot;, lambda)
end
</code></pre>
<p>The solution is given by <code>Mr*x2</code>.</p>
<h3 id="task-try-to-explain-what-every-line-in-the-for-loop-does-ie-what-is-it-calculating-you-can-also-refer-to-algorithm-2-in-this-paper-for-more-detailsexplanations-if-you-have-any-question-let-francis-know"><em>Task: try to explain what every line in the for-loop does, i.e. what is it calculating. You can also refer to Algorithm 2 in this <a href="https://slim.gatech.edu/Publications/Public/Journals/Geophysics/2019/witte2018cls/witte2018cls.pdf">paper</a> for more details/explanations. If you have any question, let Francis know : )</em></h3>
<h3 id="task-juxtapose-4-images-the-true-dm-the-rtm-result-the-ls-rtm-result-from-lsqr-the-sparsity-promoting-ls-rtm-from-linearized-bregman-what-do-you-see-remember-our-goal-is-to-get-an-image-that-is-similar-to-the-true-dm"><em>Task: Juxtapose 4 images: the true <code>dm</code>, the RTM result, the LS-RTM result from LSQR, the sparsity-promoting LS-RTM from Linearized Bregman. What do you see? Remember, our goal is to get an image that is similar to the true <code>dm</code>.</em></h3>
<h3 id="task-the-seismic-images-except-for-the-true-dm-above-are-focusing-mainly-in-the-central-region-why-hint-check-sourcereceiver-locations-how-can-we-get-a-full-illumination-of-the-image-make-experiments-to-verify"><em>Task: The seismic images (except for the true <code>dm</code>) above are focusing mainly in the central region. Why? (Hint: check source/receiver locations) How can we get a full illumination of the image? Make experiments to verify.</em></h3>
<h3 id="task-change-acquisition-to-be-transmission-eg-put-sources-as-a-vertical-line-on-the-left-receivers-on-the-right-show-what-rtm-image-looks-like-describe-your-observations-and-try-to-interpret-the-result-is-it-the-same-as-you-got-from-the-reflection-geometry"><em>Task: change acquisition to be transmission -- e.g. put sources as a vertical line on the left, receivers on the right. Show what RTM image looks like. Describe your observations and try to interpret the result. Is it the same as you got from the reflection geometry?</em></h3></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
