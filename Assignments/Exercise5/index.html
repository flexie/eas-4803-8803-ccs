<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Assignment 4: From processing to inversion I - Seismic Monitoring CCS</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Seismic Monitoring CCS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Outline</a>
                            </li>
                            <li class="navitem">
                                <a href="../../goals/" class="nav-link">Goals</a>
                            </li>
                            <li class="navitem">
                                <a href="../../reading/" class="nav-link">Reading</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Homework</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#assignment-4-from-processing-to-inversion-i" class="nav-link">Assignment 4: From processing to inversion I</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#contents" class="nav-link">Contents</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#linear-systems" class="nav-link">Linear systems</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#tasks" class="nav-link">Tasks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#joli" class="nav-link">JOLI</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#deconvolution" class="nav-link">Deconvolution</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#2d-compressive-sensing" class="nav-link">2D compressive sensing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="assignment-4-from-processing-to-inversion-i">Assignment 4: From processing to inversion I</h1>
<h1 id="contents">Contents</h1>
<ul>
<li>Linear systems</li>
<li>JOLI</li>
<li>Deconvolotion</li>
</ul>
<h2 id="linear-systems">Linear systems</h2>
<p>A matrix is represented in Julia as follows</p>
<pre><code class="language-julia">A = [1 2;3 -1]
</code></pre>
<pre><code>2×2 Array{Int64,2}:
 1   2
 3  -1
</code></pre>
<p>The transpose of a matrix is obtained via</p>
<p>A'</p>
<pre><code class="language-julia">A'
</code></pre>
<pre><code>2×2 LinearAlgebra.Adjoint{Int64,Array{Int64,2}}:
 1   3
 2  -1
</code></pre>
<p>In a similar manner, we can define a column vector as follows</p>
<pre><code class="language-julia">x = [2; 2]
</code></pre>
<pre><code>2-element Array{Int64,1}:
 2
 2
</code></pre>
<ul>
<li>Describe two ways to define a row vector.</li>
</ul>
<p>Now, consider the matrices</p>
<pre><code class="language-julia">A1 = [1/sqrt(2) 2/3 sqrt(2)/6;0 1/3 -2*sqrt(2)/3;-1/sqrt(2) 2/3 sqrt(2)/6];
A2 = [0 2 2;2 1 -3;1 0 -2];
A3 = [3 1;1 0;2 1];
A4 = [2 4 3; 1 3 1];
</code></pre>
<h1 id="tasks">Tasks</h1>
<ul>
<li>Look at A1'*A1, what kind of matrix is A1? What does this mean?</li>
<li>Look at A2<em>[1;2;3] and A2</em>[3;1;4], what can you say about the matrix A2?</li>
<li>What do you call a linear system defined by matrix A3?</li>
<li>What do you call a linear system defined by matrix A4?</li>
</ul>
<p>If a matrix is invertible, we can explicitly find the inverse with inv</p>
<ul>
<li>find a solution of A1*x = [6;-3;0], is there only one solution? Do you really need inv here?</li>
<li>find a solution of A2*x = [4;0;-1], is there only one solution? What characterizes the solution you found?</li>
<li>find a solution of A3*x = [5;2;5], is there only one solution? What characterizes the solution you found?</li>
<li>find a solution of A4*x = [10;5], is there only one solution? What characterizes the solution you found?</li>
</ul>
<h1 id="joli">JOLI</h1>
<p>https://github.com/slimgroup/JOLI.jl</p>
<p>The JOLI toolbox gives a way to represent matrices implicitly. A nice example is the Fourier transform. In julia, the Fourier transform of a vector is given by fft(x). We can explicitly construct a matrix representing the Fourier transform as follows</p>
<pre><code class="language-julia">using FFTW
# dimension
N  = 10
F1 = zeros(Complex{Float64}, N,N)
for k = 1:N
    # construct k-th unit vector
    ek = zeros(N,1)
    ek[k] = 1

    # make column of matrix
    F1[:, k]= fft(ek)
end

</code></pre>
<ul>
<li>Look at the matrix, what do you notice?</li>
<li>Verify that it gives the same result as fft by trying on a vector</li>
</ul>
<p>We can also define the FFT using JOLI:</p>
<pre><code class="language-julia">using JOLI
</code></pre>
<pre><code class="language-julia">F2  = joDFT(N)
</code></pre>
<pre><code class="language-julia">varinfo(r&quot;F1&quot;), varinfo(r&quot;F2&quot;)
</code></pre>
<pre><code>(| name |      size | summary                         |
|:---- | ---------:|:------------------------------- |
| F1   | 1.602 KiB | 10×10 Array{Complex{Float64},2} |
, | name |      size | summary                                    |
|:---- | ---------:|:------------------------------------------ |
| F2   | 566 bytes | joLinearFunction{Float64,Complex{Float64}} |
)
</code></pre>
<p>And this is only a small example! The reason why we want to have such operations behave like matrices is that we can use (some) standard algorithms that where written to work with matrices to work with large scale operations. As an example we use a Gaussian matrix:</p>
<pre><code class="language-julia">N  = 10000;
# NxN Gaussian matrix
G1 = ones(N, N);
</code></pre>
<pre><code class="language-julia"># NxN Gaussian JOLI operator (will represent a different matrix than G1 becuase it is gerenated randomly)
G2 = joOnes(N);
</code></pre>
<pre><code class="language-julia">varinfo(r&quot;G1&quot;),varinfo(r&quot;G2&quot;)
</code></pre>
<pre><code>(| name |        size | summary                      |
|:---- | -----------:|:---------------------------- |
| G1   | 762.939 MiB | 10000×10000 Array{Float64,2} |
, | name |      size | summary                   |
|:---- | ---------:|:------------------------- |
| G2   | 246 bytes | joMatrix{Float64,Float64} |
)
</code></pre>
<h1 id="deconvolution">Deconvolution</h1>
<p>We some signal <span class="arithmatex">\(f(t)\)</span> which is a convolution of some unkown signal <span class="arithmatex">\(g(t)\)</span> and a known filter <span class="arithmatex">\(w(t)\)</span>. Given <span class="arithmatex">\(f\)</span> and <span class="arithmatex">\(w\)</span> we would like to retreive <span class="arithmatex">\(g\)</span>.</p>
<p>For the example we use:</p>
<pre><code class="language-julia"># time axis
t = 0:.001:2';
N = length(t);

# true signal g has approx k spikes with random amplitudes
k = 20;
g = zeros(N,1);
g[rand(1:N, k)] = randn(k,1);

# filter
w = (1 .-2*1e3*(t .-.2).^2).*exp.(-1e3*(t .-.2).^2);

# plot
using PyPlot
figure();
plot(t,g);
xlabel(&quot;t [s]&quot;);ylabel(&quot;g(t)&quot;);

figure();
plot(t,w);
xlabel(&quot;t [s]&quot;);ylabel(&quot;w(t)&quot;);
</code></pre>
<pre><code>┌ Info: Recompiling stale cache file /home/yzhang3198/.julia/compiled/v1.2/PyPlot/oatAj.ji for PyPlot [d330b81b-6aea-500a-939a-2ce795aea3ee]
└ @ Base loading.jl:1240
</code></pre>
<p><img alt="png" src="../../img/E5_output_24_1.png" /></p>
<p><img alt="png" src="../../img/E5_output_24_2.png" /></p>
<p>First, we consider the <code>forward</code> problem of convolving a signal, using JOLI.</p>
<h3 id="task-perform-the-convolution-using-the-usual-julia-commands-fft-ifft-and-element-wise-multiplication-name-your-result-f1-hint-what-is-convolution-in-frequency-domain">Task: Perform the convolution using the usual julia commands fft, ifft and element-wise multiplication. Name your result f1. Hint: what is convolution in frequency domain?*.</h3>
<p>We can also create a JOLI operator to do the same. We can construct an operator to do the multiplication with the filter using joDiag.</p>
<pre><code class="language-julia"># JOLI operator to perform convolution.
C = joDFT(N)'*joDiag(wf)*joDFT(N);
f2 = C*g;

figure();
plot(t,f1)
plot(t,f2)
plot(t,g);
xlabel(&quot;t [s]&quot;);ylabel(&quot;f(t)&quot;);legend([&quot;normal&quot;,&quot;JOLI&quot;, &quot;g&quot;]);
</code></pre>
<h3 id="task">Task</h3>
<ul>
<li>Compare the results of both.</li>
<li>Compare f to g, what do you notice?</li>
<li>Assuming that your convolution operator is called C: Do you think C has a null-space? If so, describe it. (Hint: look at the filter).</li>
</ul>
<p>Now, construct the signal f using your JOLI operator and add some noise.</p>
<pre><code class="language-julia">f = C*g + 1e-3*randn(N);
</code></pre>
<h3 id="task_1">Task</h3>
<p>Use the adjoint of C as an approximation to the inverse, i.e. approximate the adjoint of C to the observation f. what does this correspond to and what does the reconstruction look like?</p>
<h3 id="task_2">Task</h3>
<p>Follow the script below, use lsqr to invert for g. (you might need to increase the number of iterations.)
Look at the signal that is predicted by your reconstruction, do you see a difference with the true signal?</p>
<pre><code class="language-julia">#import Pkg;
#Pkg.add(&quot;IterativeSolvers&quot;)
# true signal

using IterativeSolvers
gt = lsqr(C, f, damp=1e0)
</code></pre>
<p>lsqr will give us a solution that has a small two-norm and explains the data. Alternatively, we can use another solver that will give us a spiky solution and explains the data. This solver is spgl1. Try inversion via spgl1.</p>
<p>https://github.com/slimgroup/GenSPGL.jl</p>
<pre><code class="language-julia">using GenSPGL
# Pkg.add(url=&quot;https://github.com/slimgroup/GenSPGL.jl&quot;)
using LinearAlgebra
# Solve
opts = spgOptions(optTol = 1e-10,
                  verbosity = 1)

#gtt, r, grads, info = spgl1(C, vec(f), tau = 0., sigma = norm(f - C*gt));
</code></pre>
<h3 id="task_3">Task</h3>
<ul>
<li>Is this solution closer to the true one?</li>
<li>Look at the predicted signal for this solution, do you see a difference with the true signal? Can we really say that this is a better solution? </li>
</ul>
<h2 id="2d-compressive-sensing">2D compressive sensing</h2>
<p>In the following experiment, we extend the 1D compressive sensing to 2D---i.e., we aim to recover a sparse image (rather than a vector). Let's first set up the ground truth vector <span class="arithmatex">\(g\)</span>.</p>
<pre><code class="language-julia">n = (64, 64);
nn = prod(n);
k = 200;
g = zeros(n);
idx1 = rand(1:n[1], k);
idx2 = rand(1:n[1], k);
for i = 1:k
    g[idx1[i],idx2[i]] = randn();
end
</code></pre>
<h3 id="task-plot-g-by-imshow-function-with-colorbars-is-g-sparse-how-many-non-zero-entries-are-in-g">Task: plot <span class="arithmatex">\(g\)</span> by <code>imshow</code> function with colorbars. Is <span class="arithmatex">\(g\)</span> sparse? How many non-zero entries are in <span class="arithmatex">\(g\)</span>?</h3>
<p>Then, let's make a forward operator <span class="arithmatex">\(A\)</span> by JOLI. Following what we did in 1D, we hit the ground truth vector by the matrix <span class="arithmatex">\(A\)</span> and add some noise to get the observation <span class="arithmatex">\(y\)</span>. Notice that the operator <span class="arithmatex">\(A\)</span> works on vectorized image.</p>
<pre><code class="language-julia">subsamp = 0.25f0 # 25% subsampling ratio
A = joRestriction(nn, sort(randperm(nn)[1:Int(round(subsamp*nn))]))*joRomberg(n[1],n[2])
y = A * vec(g) + 1f-3*randn(size(A,1));
</code></pre>
<h3 id="task-do-lsqr-and-spgl1-plot-the-results-compare-with-each-other-what-do-you-see">Task: do LSQR and SPGL1. Plot the results. Compare with each other. What do you see?</h3>
<h3 id="task-compute-the-norm-of-the-residuals-from-the-results-by-lsqr-and-spgl1-which-one-is-larger-any-conclusion-from-these-experiments">Task: compute the norm of the residuals from the results by LSQR and SPGL1. Which one is larger? Any conclusion from these experiments?</h3></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
