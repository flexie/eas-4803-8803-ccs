<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Exercise 6: From processing to inversion II - Seismic Monitoring CCS</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Seismic Monitoring CCS</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../outline/" class="nav-link">Outline</a>
                            </li>
                            <li class="navitem">
                                <a href="../../goals/" class="nav-link">Goals</a>
                            </li>
                            <li class="navitem">
                                <a href="../../reading/" class="nav-link">Reading</a>
                            </li>
                            <li class="navitem">
                                <a href="../../homework/" class="nav-link">Homework</a>
                            </li>
                            <li class="navitem">
                                <a href="../../project/" class="nav-link">Projects</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#exercise-6-from-processing-to-inversion-ii" class="nav-link">Exercise 6: From processing to inversion II</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#kronecker" class="nav-link">Kronecker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#nmo-stack-deconvolution" class="nav-link">NMO-Stack-deconvolution</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#inverting-the-radon-transform" class="nav-link">Inverting the Radon transform</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="exercise-6-from-processing-to-inversion-ii">Exercise 6: From processing to inversion II</h1>
<p>Contents:</p>
<ul>
<li>Kronecker</li>
<li>NMO-Stack-deconvolution</li>
<li>Inverting the Radon transform</li>
</ul>
<h1 id="kronecker">Kronecker</h1>
<p>Given a matrix X, we often want to apply operations along both dimensions. For example, if each column is a trace we can do a temporal fourier transform of each trace as follows</p>
<pre><code class="language-julia">using JOLI, GenSPGL, PyPlot, FFTW, LinearAlgebra
</code></pre>
<pre><code class="language-julia"># dummy matrix
n1 = 10
n2 = 5
X = joComplex.(randn(n1,n2))
# fft along first dimension
F1 = joDFT(n1; DDT=joComplex)
Y  = F1*X
</code></pre>
<pre><code>10×5 Array{Complex{Float64},2}:
   1.41557+0.0im        -1.60638+0.0im       …   0.430018+0.0im      
  0.672767+0.450352im  -0.938118+0.759956im       -0.1883-0.991497im 
  0.406392+0.205739im  -0.302384+0.247512im      0.631065-1.30804im  
 -0.618123-0.848047im  -0.121208+0.443261im     -0.646604-1.17498im  
 -0.787335-0.450483im  0.0533324-0.395285im     -0.760621+0.0204424im
  0.294818+0.0im       -0.429069+0.0im       …  -0.250248+0.0im      
 -0.787335+0.450483im  0.0533324+0.395285im     -0.760621-0.0204424im
 -0.618123+0.848047im  -0.121208-0.443261im     -0.646604+1.17498im  
  0.406392-0.205739im  -0.302384-0.247512im      0.631065+1.30804im  
  0.672767-0.450352im  -0.938118-0.759956im       -0.1883+0.991497im
</code></pre>
<p>We can do an fft along the second dimension as follows</p>
<pre><code class="language-julia">F2 = joDFT(n2; DDT=joComplex)
Y  = transpose(F2*copy(transpose(X)));
</code></pre>
<p>Finally, we can combine both in one step as follows</p>
<pre><code class="language-julia">Y = transpose(F2*copy(transpose(F1*X)));
</code></pre>
<p>We can do the equivalent operation on the vectorized version of X via the Kronecker product. The formula is :</p>
<p>$ \mathrm{vec}(AXB) = (B^T\otimes A)\mathrm{vec}(X) $.</p>
<p>where $\mathrm{vec}$ vectorizes a matrix $X(:)$.</p>
<p>Use joKron to construct a 2D fft operator that works on a vectorized version of X, X(:).
Show that the result is the same as when using the operators F1 and F2 separately.</p>
<pre><code class="language-julia"># 2D FFT operator
F12 = joKron(F2,F1);

# compare: F12*X(:) should be the same as Y(:)
norm(F12*X[:] - Y[:])

</code></pre>
<pre><code>0.0
</code></pre>
<h1 id="nmo-stack-deconvolution">NMO-Stack-deconvolution</h1>
<p>We revisit the NMO and stack operations we saw a few weeks before, but we will use it <code>backwards</code>. Remember the conventional flow was Data -&gt; NMO corrected data -&gt; stack -&gt; image We will now traverse this chain in the reverse order, each time using the adjoint of the operations.</p>
<p>The reflectivity (image) can be represented by a convolution of a spike train with a wavelet, as we saw last week. We will build this chain of operations reflectivity -&gt; convolved reflectivity -&gt; NMO corrected data -&gt; data, step-by-step.</p>
<p>First, define a time and offset axis.</p>
<pre><code class="language-julia"># time and offset grid
t = Float64.(0:.004:1);  nt = length(t);
h =  Float64.(0.0:10.0:1000.0); nh = length(h);
</code></pre>
<p>We make a reflectivity series with 3 spikes and define a wavelet.</p>
<pre><code class="language-julia"># reflectivity
r = zeros(nt,1);
r[51] = 1
r[101] = -.5
r[151] = .75

# wavelet
w = (1 .-2*1e3*(t .-.1).^2).*exp.(-1e3 .*(t .-.1).^2)
</code></pre>
<pre><code>251-element Array{Float64,1}:
 -0.0008625986654872107
 -0.0017333620023927386
 -0.003359640068423334 
 -0.00627815407118934  
 -0.011305429764281264 
 -0.019606375823452423 
 -0.032722754572662376 
 -0.05251269265727092  
 -0.08094144772594736  
 -0.11966839901351634  
 -0.16940707917321376  
 -0.22910148611303477  
 -0.29505929933463465  
  ⋮                    
 -8.75952886e-316      
 -9.2021e-319          
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0                  
 -0.0
</code></pre>
<p>The convolution is done by using the FFT SPOT operators, just like in the last exercise.</p>
<pre><code class="language-julia"># convolution operator
C = joDFT(nt)'*joDiag(fft(w))*joDFT(nt);
</code></pre>
<p>Next, we need to extend the the reflectivity to be a function of time and offset. We are trying to undo the stack operation to create NMO corrected data. Let's first look at the stack. Given a matrix, we can stack the columns by multiplying with a vector of all ones:</p>
<pre><code class="language-julia"># test matrix
X =[1 2; 3 4; 5 6]
Y = X*[1;1]
</code></pre>
<pre><code>3-element Array{Int64,1}:
  3
  7
 11
</code></pre>
<ul>
<li>Construct a JOLI operator that stacks a vectorized input matrix of size nt x nh along the columns. Use joDirac to define an identity operator.</li>
<li>Apply the operators C and S to the vector r to get something that resembles NMO-corrected data. You can reshape the vector into a matrix by using reshape. Plot the result.</li>
</ul>
<p>The next step is to construct an NMO operator. Please follow the function <code>nmo</code> in <a href="https://flexie.github.io/-EAS4803-8803/Assignments/Exercise6/">Exercise2</a> and define a JOLI operator for a constant velocity of 2000 m/s. Don't forget to take care of the shape of input and output (they should both be vectors in proper lengths). You can do this by simply filling the blanks below. Apply it to the result of the previous exercise and plot the result.</p>
<pre><code class="language-julia">function nmo(cmp, t, off, v,flag)
# NMO correction and adjoint 
#
# use:
#   out = nmo(in,t,h,v,flag)
#
# input:
#   in   - data matrix of size [length(t) x length(h)], each column is a trace 
#   t    - time vector [s]
#   offsets    - offset vector [m]
#   v    - NMO velocity [m/s] as vector of size [length(t) x 1].
#   flag - 1:forward, -1:adjoint
#
# output
#   out  - data matrix of size [length(t) x length(h)], each column is a trace 
    if size(cmp, 2) == 1
        return cmp
    end
    # size of data
    nt, nh = size(cmp)
    # make sure t and v are column vectors
    t = t[:]
    v = v[:]
    # initialize output
    out = zeros(nt, nh)
    # loop over offset

    for i = 1:nh
        # NMO traveltime
        tau = sqrt.(t.^2 + off[i].^2 ./v.^2);

        A = getLA(t,tau);
        # interpolate, forward or adjoint
        new = zeros(size(out[:,i]))
        if flag == 1
            new[1:size(A*cmp[:,i])[1]] = A*cmp[:,i]
        else
            new[1:size(A'*cmp[:,i])[1]] = A'*cmp[:,i]
        end
        out[:,i] = new[1:nt]
        #cmp
    end
    return vec(out)
end

function nmo_forward(vec_cmp,t,h,vel) 
    mat_cmp = _ # to be done
    return nmo(mat_cmp,t,h,vel,1)
end
function nmo_adjoint(vec_cmp,t,h,vel) 
    mat_cmp = _ # to be done
    return nmo(mat_cmp,t,h,vel,-1)
end

function joNMO(t,h,vel, n)
    C = joLinearFunctionFwd_T(n, n,
        v -&gt; nmo_forward(v, t,h,vel),
        w -&gt; nmo_adjoint(w, t,h,vel),
        Float64, Float64,name=&quot;NMO operator&quot;)
end
B = joNMO(_, _, _, _)
</code></pre>
<p>Now, define a combined operator that predicts data given a spike train.</p>
<ul>
<li>Check that your combined operator satisfies the dottest</li>
<li>Make data for the spike train r and add some noise.</li>
<li>Invert the operator with both lsqr and spgl1 (see previous exercise).</li>
</ul>
<h1 id="inverting-the-radon-transform">Inverting the Radon transform</h1>
<p>In the previous exercise we saw that the Radon transform is not unitary. This means that its adjoint is not its inverse. Here, we will set up a JOLI operator for the Radon transform and invert it using lsqr and spgl1. If the computation takes too long you can use a coarser sampling of the q axis.</p>
<ul>
<li>read the data parab.segy</li>
<li>Set up a parabolic radon transform JOLI operator , R=joRadon(....; DDT=joFloat)</li>
<li>Plot the data in the Radon domain, and go back to the orininal data using the adjoint. Compare to the original data. - - What do you notice?</li>
<li>You want to obtain data in the Radon domain b for which the predicted data in the t,h domain is close to the original data. How would you do this?.</li>
<li>Setup a damped least-squares system and invert with lsqr. Try different damping parameters and explain what you see. Hint: us lsqr(..., damp=) for a damped least square.</li>
<li>Use the original system and invert with spgl1(A,b,0,tolerance).</li>
<li>Describe a possible application of this technique in seismic processing</li>
</ul>
<p>Do not forget to turn your data into Float64</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
